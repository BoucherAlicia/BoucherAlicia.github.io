<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historique des Mesures</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link rel="stylesheet" href="styles/main.css">
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
</head>
<body>
    <div class="container">
        <header class="history-header">
            <h1>Votre Historique</h1>
            <div class="user-info">Utilisateur: <span id="currentUserDisplay"></span></div>
        </header>

        <div id="historyContainer"></div>

        <button class="btn" id="backBtn">← Retour à la mesure</button>
    </div>
    <!-- Ajoutez ce bouton en bas de la page -->
    <div class="history-actions">
        <button id="deleteAllBtn" class="btn btn-danger">Effacer tout l'historique</button>
    </div>
    <script src="scripts/db.js"></script>
    <script src="scripts/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = localStorage.getItem('currentUser');
            const backBtn = document.getElementById('backBtn');
            // Vérifier le mode de connexion
            const connectionMode = localStorage.getItem('connectionMode');

            if (connectionMode === 'simulation' || connectionMode === 'bluetooth') {
                backBtn.textContent = '← Retour à la mesure';
                backBtn.onclick = () => window.location.href = 'measure.html';
            } else {
                backBtn.textContent = '← Retour à l\'accueil';
                backBtn.onclick = () => window.location.href = 'index.html';
            }

            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            const historyContainer = document.getElementById('historyContainer');
            const userDisplay = document.getElementById('currentUserDisplay');
            
            // Afficher le nom de l'utilisateur
            userDisplay.textContent = currentUser || 'Non défini';
            
            // Si pas d'utilisateur connecté
            if (!currentUser) {
                historyContainer.innerHTML = `
                    <div class="no-data">
                        <h3>Aucun utilisateur connecté</h3>
                        <p>Veuillez vous connecter pour voir votre historique</p>
                    </div>
                `;
                return;
            }
            
            // Récupérer les mesures de l'utilisateur actuel seulement
            const userMeasurements = getAllMeasurements()
                .filter(m => m.userName === currentUser)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            // Si pas de mesures
            if (userMeasurements.length === 0) {
                historyContainer.innerHTML = `
                    <div class="no-data">
                        <h3>Aucune mesure enregistrée</h3>
                        <p>Effectuez des mesures pour les voir apparaître ici</p>
                    </div>
                `;
                return;
            }
            
            // Afficher chaque mesure
            userMeasurements.forEach((measurement, index) => {
                const card = document.createElement('div');
                card.className = 'measurement-card';
                
                // Calcul des stats
                const angles = measurement.data.map(d => d.y);
                const maxAngle = Math.max(...angles).toFixed(2);
                const minAngle = Math.min(...angles).toFixed(2);
                const avgAngle = (angles.reduce((a, b) => a + b, 0) / angles.length).toFixed(2);
                
                card.innerHTML = `
                    <div class="measurement-card">
                        <div class="measurement-header">
                            <div class="measurement-title">Session du ${new Date(measurement.timestamp).toLocaleString()}</div>
                            
                            <div class="measurement-meta">${measurement.data.length} mesures</div>
                        </div>
                        <div class="chart-container style="width:100%; height:250px;">
                            <canvas id="chart-${index}"></canvas>
                        </div>
                        <div class="stats">
                            <div class="stat-box">
                                <span>Max: </span><span class="stat-value">${maxAngle}°</span>
                            </div>
                            <div class="stat-box">
                                <span>Min: </span><span class="stat-value">${minAngle}°</span>
                            </div>
                            <div class="stat-box">
                                <span>Moyenne: </span><span class="stat-value">${avgAngle}°</span>
                            </div>
                        </div>
                        <div class="measurement-actions">
                                <button class="btn btn-sm btn-danger delete-session" data-id="${measurement.timestamp}">
                                    Supprimer cette session
                                </button>
                            </div>
                `;
                
                historyContainer.appendChild(card);
                
                // Initialiser le graphique après un léger délai
                setTimeout(() => {
                    const ctx = document.getElementById(`chart-${index}`).getContext('2d');
                    const chart = initHistoryChart(`chart-${index}`);
                    
                    // Formater les données pour Chart.js
                    const chartData = measurement.data.map(point => ({
                        x: new Date(point.x),
                        y: point.y
                    }));
                    
                    updateChart(chart, chartData);
                }, 50);
            });
        });
        
        // Bouton retour
        document.getElementById('backBtn').addEventListener('click', () => {
            window.location.href = 'measure.html';
        });
        // Gestion de la suppression d'une session
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-session')) {
            const timestamp = e.target.dataset.id;
            if (confirm('Voulez-vous vraiment supprimer cette session de mesures ?')) {
                deleteMeasurementSession(timestamp);
                e.target.closest('.measurement-card').remove();
            }
        }
    });

    // Gestion de la suppression complète
    document.getElementById('deleteAllBtn').addEventListener('click', () => {
        const currentUser = localStorage.getItem('currentUser');
        if (confirm(`Voulez-vous vraiment supprimer TOUT l'historique de ${currentUser} ?`)) {
            deleteAllMeasurements(currentUser);
            document.getElementById('historyContainer').innerHTML = `
                <div class="no-data">
                    <p>Aucune donnée disponible</p>
                </div>
            `;
        }
    });

    function deleteMeasurementSession(timestamp) {
        const measurements = getAllMeasurements();
        const updated = measurements.filter(m => m.timestamp !== timestamp);
        localStorage.setItem('measurements', JSON.stringify(updated));
    }

    function deleteAllMeasurements(username) {
        const measurements = getAllMeasurements();
        const updated = measurements.filter(m => m.userName !== username);
        localStorage.setItem('measurements', JSON.stringify(updated));
    }
    </script>
</body>
</html>